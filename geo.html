<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Africa Map Quiz (Full Edition)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='16' fill='%234CAF50'/><path fill='%23FFF' d='M16 8c-3.5 0-7 2-9 5s-2 7-1 9 4 3 7 3 6-2 8-4 3-5 1-8-4-5-6-5z'/></svg>">
    <style>
        :root {
            --tray-height: 80px;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevents scrolling on all screen sizes */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
        }

        #game-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            gap: 20px;
            height: 100%;
            box-sizing: border-box;
            position: relative; /* For positioning the stumped dropzone */
        }

        #game-container {
            display: flex;
            gap: 30px;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        #map-container {
            width: 800px;
            flex-shrink: 0; /* Prevents map from shrinking in desktop flex layout */
            height: calc(100% - 40px); /* Match sidebar for consistent bottom margin */
            position: relative;
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #scroll-padding-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #map-content {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 100%;
            max-height: 100%;
        }

        #map-content svg {
            display: block;
            max-width: 100%;
            max-height: 100%;
            height: auto;
            width: auto;
        }

        #map-container svg path {
            fill: #d4d4d4;
            stroke: #ffffff;
            stroke-width: 1px;
            transition: fill 0.2s ease-in-out;
        }
        
        #map-container svg path:hover {
            fill: #a3b4c1;
            cursor: crosshair;
        }

        #map-container svg path.highlight {
            fill: #f0ad4e;
        }
        
        #map-container svg path.correct {
            /* Marker class, colors handled by specific classes */
        }

        #map-container svg path.correct-color-1 { fill: #34d399; }
        #map-container svg path.correct-color-2 { fill: #fbbf24; }
        #map-container svg path.correct-color-3 { fill: #60a5fa; }
        #map-container svg path.correct-color-4 { fill: #f87171; }
        #map-container svg path.correct-color-5 { fill: #a855f7; }
        #map-container svg path.correct-color-6 { fill: #14b8a6; }

        #sidebar {
            width: 250px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: calc(100% - 40px); /* Adjust for body padding */
        }
        
        .country-label {
            position: absolute;
            transform: translate(-50%, -50%);
            color: black;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 0 3px white, 0 0 3px white, 0 0 3px white;
            pointer-events: none;
            user-select: none;
            text-align: center;
        }

        #info-panel {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
        }

        #info-panel h2 { margin-top: 0; }
        #timer, #score { font-size: 1.5em; font-weight: bold; color: #333; }

        #country-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .country-name {
            padding: 10px 12px;
            margin: 4px;
            font-size: 0.9em;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 5px;
            cursor: grab;
            text-align: center;
            user-select: none;
            transition: background-color 0.2s;
        }
        .country-name:hover { background-color: #dee2e6; }
        .country-name.dragging { opacity: 0.5; }

        #mobile-tray-container { display: none; } /* Hidden by default */
        
        #game-over-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        #game-over-content {
            background-color: white; padding: 40px; border-radius: 10px;
            text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #game-over-content h2 { margin-top: 0; color: #28a745; }
        #restart-button {
            padding: 10px 20px; font-size: 1em; cursor: pointer; border: none;
            border-radius: 5px; background-color: #007bff; color: white; margin-top: 20px;
        }
        #loading-indicator {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 1.2em; color: #555;
        }

        #stumped-dropzone {
            display: none; /* Hidden by default, shown on mobile */
            position: absolute;
            bottom: calc(var(--tray-height) + 25px); /* Position above the tray */
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background-color: #007bff;
            color: white;
            border: 2px dashed #0056b3;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: bold;
            font-size: 0.9em;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.25s ease-in-out, transform 0.25s ease-in-out;
            pointer-events: none;
            white-space: nowrap;
        }
        #game-wrapper.dragging-active.mobile-view #stumped-dropzone {
            opacity: 1;
            pointer-events: auto;
        }
        #stumped-dropzone.highlight {
            background-color: #0056b3;
            transform: translateX(-50%) scale(1.05);
        }

        /* MOBILE LAYOUT */
        @media (max-width: 850px) {
            #game-wrapper {
                flex-direction: column;
                padding: 10px;
                gap: 10px;
            }
            #game-container {
                flex-direction: column;
                gap: 10px;
                flex-grow: 1; 
                min-height: 0; 
            }
            #sidebar { display: none; }
            #map-container { height: 100%; width: 100%; }
            #stumped-dropzone { display: block; }

            #mobile-tray-container {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            #mobile-info-panel {
                display: flex;
                justify-content: space-around;
                align-items: center;
                background-color: #fff;
                padding: 5px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                margin-bottom: 10px;
            }
            #mobile-info-panel div { font-size: 1em; }

            #mobile-country-tray {
                display: flex;
                justify-content: space-around;
                align-items: center;
                width: 100%;
                height: var(--tray-height);
            }
            .tray-slot {
                flex: 1;
                margin: 0 5px;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .tray-slot .country-name {
                width: 100%;
                padding: 8px 4px;
                font-size: 0.8em;
                box-sizing: border-box;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            #map-container {
                overflow: scroll;
                -webkit-overflow-scrolling: touch; 
                display: block;
            }

            #scroll-padding-wrapper {
                display: inline-block;
                width: auto;
                height: auto;
                padding: 0;
                transition: padding 0.3s ease-in-out;
            }

            #map-container.zoomed #scroll-padding-wrapper {
                padding: 55vh; /* Increased padding */
            }
            
            #map-content {
                display: inline-block;
                width: auto;
                height: auto;
                transform-origin: center center;
                transition: transform 0.3s ease-in-out;
            }

            #map-container.zoomed #map-content {
                transform: scale(2.25);
            }

            #map-content svg {
                height: 100vh;
                max-width: none;
                max-height: none;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <!-- Mobile-only tray -->
        <div id="mobile-tray-container">
             <div id="mobile-info-panel">
                <div>Score: <span id="mobile-score">0</span></div>
                <h2>Africa Quiz</h2>
                <div>Time: <span id="mobile-timer">0s</span></div>
            </div>
            <div id="mobile-country-tray"></div>
        </div>

        <div id="game-container">
            <div id="map-container">
                <div id="loading-indicator">Loading Map...</div>
            </div>

            <!-- Desktop-only sidebar -->
            <div id="sidebar">
                <div id="info-panel">
                    <h2>Africa Quiz</h2>
                    <div>Time: <span id="timer">0s</span></div>
                    <div>Score: <span id="score">0</span></div>
                </div>
                <ul id="country-list"></ul>
            </div>
        </div>

        <!-- Dropzone for swapping countries on mobile -->
        <div id="stumped-dropzone">Try another country</div>
    </div>


    <div id="game-over-modal">
        <div id="game-over-content">
            <h2>Congratulations!</h2>
            <p>You've completed the map.</p>
            <p>Final Time: <span id="final-time"></span></p>
            <p>Final Score: <span id="final-score"></span></p>
            <button id="restart-button">Play Again</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const countries = [
                // North Africa
                { id: 'algeria', name: 'Algeria', svgId: 'Algerien' },
                { id: 'egypt', name: 'Egypt', svgId: 'Aegypten' },
                { id: 'libya', name: 'Libya', svgId: 'Libyen' },
                { id: 'morocco', name: 'Morocco', svgId: 'Marokko' },
                { id: 'sudan', name: 'Sudan', svgId: 'Sudan' },
                { id: 'tunisia', name: 'Tunisia', svgId: 'Tunesien' },
                { id: 'western-sahara', name: 'Western Sahara', svgId: 'Westsahara' },
                // West Africa
                { id: 'benin', name: 'Benin', svgId: 'Benin' },
                { id: 'burkina-faso', name: 'Burkina Faso', svgId: 'Burkina_Faso' },
                { id: 'ivory-coast', name: 'Côte d\'Ivoire', svgId: 'Elfenbeinkueste' },
                { id: 'gambia', name: 'Gambia', svgId: 'Gambia' },
                { id: 'ghana', name: 'Ghana', svgId: 'Ghana' },
                { id: 'guinea', name: 'Guinea', svgId: 'Guinea' },
                { id: 'guinea-bissau', name: 'Guinea-Bissau', svgId: 'Guinea-Bissau' },
                { id: 'liberia', name: 'Liberia', svgId: 'Liberia' },
                { id: 'mali', name: 'Mali', svgId: 'Mali' },
                { id: 'mauritania', name: 'Mauritania', svgId: 'Mauretanien' },
                { id: 'niger', name: 'Niger', svgId: 'Niger' },
                { id: 'nigeria', name: 'Nigeria', svgId: 'Nigeria' },
                { id: 'senegal', name: 'Senegal', svgId: 'Senegal' },
                { id: 'sierra-leone', name: 'Sierra Leone', svgId: 'Sierra_Leone' },
                { id: 'togo', name: 'Togo', svgId: 'Togo' },
                // Central Africa
                { id: 'angola', name: 'Angola', svgId: 'path73' },
                { id: 'cameroon', name: 'Cameroon', svgId: 'Kamerun' },
                { id: 'central-african-republic', name: 'Central African Republic', svgId: 'Zentralafrikanische_Republik' },
                { id: 'chad', name: 'Chad', svgId: 'Tschad' },
                { id: 'drc', name: 'DRC', svgId: 'Demokratische_Republik_Kongo' },
                { id: 'republic-of-the-congo', name: 'Congo', svgId: 'Republik_Kongo' },
                { id: 'equatorial-guinea', name: 'Equatorial Guinea', svgId: 'path64' },
                { id: 'gabon', name: 'Gabon', svgId: 'Gabun' },
                 // East Africa
                { id: 'burundi', name: 'Burundi', svgId: 'Burundi' },
                { id: 'djibouti', name: 'Djibouti', svgId: 'Dschibuti' },
                { id: 'eritrea', name: 'Eritrea', svgId: 'Eritrea' },
                { id: 'ethiopia', name: 'Ethiopia', svgId: 'Aethopien' },
                { id: 'kenya', name: 'Kenya', svgId: 'Kenia' },
                { id: 'madagascar', name: 'Madagascar', svgId: 'Madagaskar' },
                { id: 'malawi', name: 'Malawi', svgId: 'Malawi' },
                { id: 'mozambique', name: 'Mozambique', svgId: 'Mosambik' },
                { id: 'rwanda', name: 'Rwanda', svgId: 'Ruanda' },
                { id: 'somalia', name: 'Somalia', svgId: 'Somalia' },
                { id: 'south-sudan', name: 'South Sudan', svgId: 'path3246' },
                { id: 'tanzania', name: 'Tanzania', svgId: 'Tasania' },
                { id: 'uganda', name: 'Uganda', svgId: 'Uganda' },
                { id: 'zambia', name: 'Zambia', svgId: 'Sambia' },
                { id: 'zimbabwe', name: 'Zimbabwe', svgId: 'Simbabwe' },
                // Southern Africa
                { id: 'botswana', name: 'Botswana', svgId: 'Botsuana' },
                { id: 'eswatini', name: 'Eswatini', svgId: 'Swasiland' }, 
                { id: 'lesotho', name: 'Lesotho', svgId: 'Lesotho' },
                { id: 'namibia', name: 'Namibia', svgId: 'Namibia' },
                { id: 'south-africa', name: 'South Africa', svgId: 'Suedafrika' }
            ];
            const countryNeighbors = {
                'Algerien': ['Libyen', 'Marokko', 'Mauretanien', 'Mali', 'Niger', 'Tunesien', 'Westsahara'], 'Aegypten': ['Libyen', 'Sudan'], 'Libyen': ['Aegypten', 'Algerien', 'Tschad', 'Niger', 'Sudan', 'Tunesien'], 'Marokko': ['Algerien', 'Westsahara'], 'Sudan': ['Aegypten', 'Libyen', 'Tschad', 'Zentralafrikanische_Republik', 'Aethopien', 'Eritrea', 'path3246'], 'Tunesien': ['Algerien', 'Libyen'], 'Westsahara': ['Algerien', 'Marokko', 'Mauretanien'], 'Benin': ['Burkina_Faso', 'Niger', 'Nigeria', 'Togo'], 'Burkina_Faso': ['Benin', 'Elfenbeinkueste', 'Ghana', 'Mali', 'Niger', 'Togo'], 'Elfenbeinkueste': ['Burkina_Faso', 'Ghana', 'Guinea', 'Liberia', 'Mali'], 'Gambia': ['Senegal'], 'Ghana': ['Burkina_Faso', 'Elfenbeinkueste', 'Togo'], 'Guinea': ['Elfenbeinkueste', 'Guinea-Bissau', 'Liberia', 'Mali', 'Senegal', 'Sierra_Leone'], 'Guinea-Bissau': ['Guinea', 'Senegal'], 'Liberia': ['Elfenbeinkueste', 'Guinea', 'Sierra_Leone'], 'Mali': ['Algerien', 'Burkina_Faso', 'Elfenbeinkueste', 'Guinea', 'Mauretanien', 'Niger', 'Senegal'], 'Mauretanien': ['Algerien', 'Mali', 'Senegal', 'Westsahara'], 'Niger': ['Algerien', 'Benin', 'Burkina_Faso', 'Tschad', 'Libyen', 'Mali', 'Nigeria'], 'Nigeria': ['Benin', 'Kamerun', 'Tschad', 'Niger'], 'Senegal': ['Gambia', 'Guinea', 'Guinea-Bissau', 'Mali', 'Mauretanien'], 'Sierra_Leone': ['Guinea', 'Liberia'], 'Togo': ['Benin', 'Burkina_Faso', 'Ghana'], 'path73': ['Demokratische_Republik_Kongo', 'Republik_Kongo', 'Namibia', 'Sambia'], 'Kamerun': ['Zentralafrikanische_Republik', 'Tschad', 'Republik_Kongo', 'path64', 'Gabun', 'Nigeria'], 'Zentralafrikanische_Republik': ['Kamerun', 'Tschad', 'Demokratische_Republik_Kongo', 'Republik_Kongo', 'Sudan', 'path3246'], 'Tschad': ['Kamerun', 'Zentralafrikanische_Republik', 'Libyen', 'Niger', 'Nigeria', 'Sudan'], 'Demokratische_Republik_Kongo': ['path73', 'Zentralafrikanische_Republik', 'Republik_Kongo', 'path3246', 'Uganda', 'Ruanda', 'Burundi', 'Tasania', 'Sambia'], 'Republik_Kongo': ['path73', 'Kamerun', 'Zentralafrikanische_Republik', 'Demokratische_Republik_Kongo', 'Gabun'], 'path64': ['Kamerun', 'Gabun'], 'Gabun': ['Kamerun', 'Republik_Kongo', 'path64'], 'Burundi': ['Demokratische_Republik_Kongo', 'Ruanda', 'Tasania'], 'Dschibuti': ['Eritrea', 'Aethopien', 'Somalia'], 'Eritrea': ['Dschibuti', 'Aethopien', 'Sudan'], 'Aethopien': ['Dschibuti', 'Eritrea', 'Kenia', 'Somalia', 'path3246', 'Sudan'], 'Kenia': ['Aethopien', 'Somalia', 'path3246', 'Tasania', 'Uganda'], 'Madagaskar': [], 'Malawi': ['Mosambik', 'Tasania', 'Sambia'], 'Mosambik': ['Malawi', 'Suedafrika', 'Swasiland', 'Tasania', 'Sambia', 'Simbabwe'], 'Ruanda': ['Burundi', 'Demokratische_Republik_Kongo', 'Tasania', 'Uganda'], 'Somalia': ['Dschibuti', 'Aethopien', 'Kenia'], 'path3246': ['Zentralafrikanische_Republik', 'Demokratische_Republik_Kongo', 'Aethopien', 'Kenia', 'Sudan', 'Uganda'], 'Tasania': ['Burundi', 'Demokratische_Republik_Kongo', 'Kenia', 'Malawi', 'Mosambik', 'Ruanda', 'Uganda', 'Sambia'], 'Uganda': ['Demokratische_Republik_Kongo', 'Kenia', 'Ruanda', 'path3246', 'Tasania'], 'Sambia': ['path73', 'Botsuana', 'Demokratische_Republik_Kongo', 'Malawi', 'Mosambik', 'Namibia', 'Tasania', 'Simbabwe'], 'Simbabwe': ['Botsuana', 'Mosambik', 'Suedafrika', 'Sambia'], 'Botsuana': ['Namibia', 'Suedafrika', 'Sambia', 'Simbabwe'], 'Swasiland': ['Mosambik', 'Suedafrika'], 'Lesotho': ['Suedafrika'], 'Namibia': ['path73', 'Botsuana', 'Suedafrika', 'Sambia'], 'Suedafrika': ['Botsuana', 'Lesotho', 'Mosambik', 'Namibia', 'Swasiland', 'Simbabwe']
            };
            const colors = ['correct-color-1', 'correct-color-2', 'correct-color-3', 'correct-color-4', 'correct-color-5', 'correct-color-6'];
            const countrySvgIds = countries.map(c => c.svgId);
            
            // --- UI Elements ---
            const gameWrapper = document.getElementById('game-wrapper');
            const mapContainer = document.getElementById('map-container');
            const gameOverModal = document.getElementById('game-over-modal');
            const stumpedDropzone = document.getElementById('stumped-dropzone');
            // Desktop
            const countryList = document.getElementById('country-list');
            const scoreEl = document.getElementById('score');
            const timerEl = document.getElementById('timer');
            // Mobile
            const mobileTray = document.getElementById('mobile-country-tray');
            const mobileScoreEl = document.getElementById('mobile-score');
            const mobileTimerEl = document.getElementById('mobile-timer');

            // --- Game State ---
            let score = 0;
            let timer = 0;
            let timerInterval;
            let unplacedCountries = [];
            const TRAY_SIZE = 4;
            let isMobile = window.innerWidth <= 850;

            // Global state for touch drag
            let touchDragState = {
                isDragging: false,
                draggedEl: null,
                ghostEl: null,
                draggedSvgId: null,
                lastHighlight: null,
            };

            function checkIsMobile() {
                isMobile = window.innerWidth <= 850;
                gameWrapper.classList.toggle('mobile-view', isMobile);
            }

            async function initGame() {
                score = 0;
                timer = 0;
                if (timerInterval) clearInterval(timerInterval);
                updateScore(0);
                updateTimer(0);
                
                checkIsMobile();
                gameOverModal.style.display = 'none';
                if(document.getElementById('map-content')) {
                     document.querySelectorAll('.country-label').forEach(label => label.remove());
                }

                unplacedCountries = [...countries];
                
                if (isMobile) {
                    setupMobileTray();
                } else {
                    setupDesktopSidebar();
                }
                
                await loadMap();

                if (isMobile) {
                    setTimeout(() => {
                        const maxScrollLeft = mapContainer.scrollWidth - mapContainer.clientWidth;
                        const maxScrollTop = mapContainer.scrollHeight - mapContainer.clientHeight;
                        mapContainer.scrollLeft = maxScrollLeft / 2;
                        mapContainer.scrollTop = maxScrollTop / 2;
                    }, 50); 
                }

                startTimer();
            }

            function setupDesktopSidebar() {
                countryList.innerHTML = '';
                const shuffled = [...countries].sort(() => Math.random() - 0.5);
                shuffled.forEach(country => {
                    countryList.appendChild(createDraggableElement(country));
                });
                addDragListenersToAll();
            }
            
            function populateSingleTraySlot(slot) {
                if (slot.childElementCount === 0 && unplacedCountries.length > 0) {
                    const randomIndex = Math.floor(Math.random() * unplacedCountries.length);
                    const country = unplacedCountries.splice(randomIndex, 1)[0];
                    
                    const draggableEl = createDraggableElement(country);
                    slot.appendChild(draggableEl);
                    addDragListenersToElement(draggableEl);
                }
            }

            function setupMobileTray() {
                mobileTray.innerHTML = '';
                for (let i = 0; i < TRAY_SIZE; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'tray-slot';
                    mobileTray.appendChild(slot);
                }
                const traySlots = document.querySelectorAll('.tray-slot');
                traySlots.forEach(populateSingleTraySlot);
            }

            function createDraggableElement(country) {
                const li = document.createElement('div');
                li.className = 'country-name';
                li.draggable = true;
                li.id = `name-${country.id}`;
                li.dataset.svgId = country.svgId;
                li.textContent = country.name;
                return li;
            }
            
            async function loadMap() {
                mapContainer.innerHTML = '<div id="loading-indicator">Loading Map...</div>';
                try {
                    const response = await fetch('https://upload.wikimedia.org/wikipedia/commons/6/66/Blank_Map-Africa.svg');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const svgText = await response.text();
                    
                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(svgText, "image/svg+xml");
                    const svgElement = svgDoc.documentElement;
                    
                    svgElement.removeAttribute('width');
                    svgElement.removeAttribute('height');
                    
                    mapContainer.innerHTML = ''; 
                    const mapContent = document.createElement('div');
                    mapContent.id = 'map-content';
                    mapContent.appendChild(svgElement);

                    const scrollPaddingWrapper = document.createElement('div');
                    scrollPaddingWrapper.id = 'scroll-padding-wrapper';
                    scrollPaddingWrapper.appendChild(mapContent);
                    mapContainer.appendChild(scrollPaddingWrapper);
                    
                    const escapeCssSelector = (id) => id.replace(/([ \!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~])/g, '\\$1');

                    countrySvgIds.forEach(id => {
                        const path = svgElement.querySelector(`#${escapeCssSelector(id)}`);
                        if (path) path.removeAttribute('style');
                    });

                    svgElement.addEventListener('dragover', handleDragOver);
                    svgElement.addEventListener('drop', handleDrop);
                    svgElement.addEventListener('dragenter', handleDragEnter);
                    svgElement.addEventListener('dragleave', handleDragLeave);

                } catch (error) {
                    mapContainer.innerHTML = `<p style="color: red;">Failed to load map: ${error.message}</p>`;
                }
            }

            function updateScore(newScore) {
                score = newScore;
                scoreEl.textContent = score;
                mobileScoreEl.textContent = score;
            }

            function updateTimer(newTime) {
                timer = newTime;
                timerEl.textContent = `${timer}s`;
                mobileTimerEl.textContent = `${timer}s`;
            }

            function startTimer() {
                const startTime = Date.now();
                timerInterval = setInterval(() => {
                    updateTimer(Math.floor((Date.now() - startTime) / 1000));
                }, 1000);
            }
            
            function setZoom(zoomed) {
                 if (isMobile) {
                    const wasZoomed = mapContainer.classList.contains('zoomed');
                    if (wasZoomed === zoomed) return; 

                    mapContainer.classList.toggle('zoomed', zoomed);

                    setTimeout(() => {
                        const maxScrollLeft = mapContainer.scrollWidth - mapContainer.clientWidth;
                        const maxScrollTop = mapContainer.scrollHeight - mapContainer.clientHeight;
                        
                        // When zooming in, center the view. When zooming out, do nothing.
                        if (zoomed) {
                             mapContainer.scrollTo({
                                left: maxScrollLeft / 2,
                                top: maxScrollTop / 2,
                                behavior: 'smooth'
                            });
                        }
                    }, 50);
                 }
            }

            function handleAutoScroll(clientX, clientY) {
                if (!isMobile || !mapContainer) return;

                const mapRect = mapContainer.getBoundingClientRect();

                const maxScrollLeft = mapContainer.scrollWidth - mapContainer.clientWidth;
                if (maxScrollLeft > 0) {
                    const posInContainerX = clientX - mapRect.left;
                    const fractionX = Math.max(0, Math.min(1, posInContainerX / mapRect.width));
                    mapContainer.scrollLeft = fractionX * maxScrollLeft;
                }
                
                const stumpedRect = stumpedDropzone.getBoundingClientRect();
                const bottomMargin = (window.innerHeight - stumpedRect.top) + 10; // dead zone below the button
                const activeHeight = mapRect.height - bottomMargin;
                const maxScrollTop = mapContainer.scrollHeight - mapContainer.clientHeight;

                if (maxScrollTop > 0 && activeHeight > 0) {
                    const posInContainerY = clientY - mapRect.top;
                    // Only scroll if touch is within the active area
                    if (posInContainerY < activeHeight) {
                        const fractionY = posInContainerY / activeHeight;
                        mapContainer.scrollTop = fractionY * maxScrollTop;
                    }
                }
            }

            function swapCountry(element) {
                const parentSlot = element.parentElement;
                const countrySvgId = element.dataset.svgId;
                const countryData = countries.find(c => c.svgId === countrySvgId);
                
                if (countryData && !unplacedCountries.some(c => c.id === countryData.id)) {
                    unplacedCountries.push(countryData);
                }
                
                if (parentSlot && parentSlot.classList.contains('tray-slot')) {
                    parentSlot.innerHTML = '';
                    populateSingleTraySlot(parentSlot);
                }
            }


            // --- Mouse Drag Events ---
            function handleDragStart(e) {
                gameWrapper.classList.add('dragging-active');
                e.dataTransfer.setData('text/plain', e.target.dataset.svgId);
                setTimeout(() => e.target.classList.add('dragging'), 0);
            }

            function handleDragEnd(e) {
                gameWrapper.classList.remove('dragging-active');
                const highlighted = document.querySelector('.highlight');
                if (highlighted) highlighted.classList.remove('highlight');
                e.target.classList.remove('dragging');
            }

            // --- Touch Drag Events ---
            function handleTouchStart(e) {
                if (e.target.classList.contains('country-name')) {
                    e.preventDefault();
                    gameWrapper.classList.add('dragging-active');
                    setZoom(true);
                    
                    const draggedEl = e.target;
                    const draggedSvgId = draggedEl.dataset.svgId;
                    const ghostEl = draggedEl.cloneNode(true);
                    
                    ghostEl.style.position = 'absolute';
                    ghostEl.style.zIndex = '1001';
                    ghostEl.style.opacity = '0.7';
                    ghostEl.style.pointerEvents = 'none';
                    document.body.appendChild(ghostEl);

                    const touch = e.touches[0];
                    ghostEl.style.left = `${touch.pageX - ghostEl.offsetWidth / 2}px`;
                    ghostEl.style.top = `${touch.pageY - ghostEl.offsetHeight / 2}px`;

                    touchDragState = { isDragging: true, draggedEl, ghostEl, draggedSvgId, lastHighlight: null };
                }
            }

            function handleTouchMove(e) {
                if (touchDragState.isDragging) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const { ghostEl } = touchDragState;
                    
                    handleAutoScroll(touch.clientX, touch.clientY);

                    ghostEl.style.left = `${touch.pageX - ghostEl.offsetWidth / 2}px`;
                    ghostEl.style.top = `${touch.pageY - ghostEl.offsetHeight / 2}px`;
                    
                    touchDragState.draggedEl.style.visibility = 'hidden';
                    
                    ghostEl.style.display = 'none';
                    const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
                    ghostEl.style.display = '';


                    if (touchDragState.lastHighlight && touchDragState.lastHighlight !== elementUnderTouch) {
                        touchDragState.lastHighlight.classList.remove('highlight');
                        touchDragState.lastHighlight = null;
                    }
                    if (stumpedDropzone !== elementUnderTouch) {
                        stumpedDropzone.classList.remove('highlight');
                    }

                    if (elementUnderTouch) {
                        if (elementUnderTouch.id === 'stumped-dropzone') {
                            elementUnderTouch.classList.add('highlight');
                        } else if (elementUnderTouch.tagName === 'path' && countrySvgIds.includes(elementUnderTouch.id) && !elementUnderTouch.classList.contains('correct')) {
                            elementUnderTouch.classList.add('highlight');
                            touchDragState.lastHighlight = elementUnderTouch;
                        }
                    }
                }
            }

            function handleTouchEnd(e) {
                if (touchDragState.isDragging) {
                    gameWrapper.classList.remove('dragging-active');
                    setZoom(false);
                    const { ghostEl, draggedSvgId, draggedEl } = touchDragState;
                    
                    draggedEl.style.visibility = 'visible';
                    
                    const touch = e.changedTouches[0];
                    const stumpedRect = stumpedDropzone.getBoundingClientRect();
                    let droppedOnStumped = false;

                    if (isMobile) {
                        droppedOnStumped = (
                            touch.clientX >= stumpedRect.left &&
                            touch.clientX <= stumpedRect.right &&
                            touch.clientY >= stumpedRect.top &&
                            touch.clientY <= stumpedRect.bottom
                        );
                    }

                    ghostEl.style.display = 'none';
                    const dropZone = document.elementFromPoint(touch.clientX, touch.clientY);
                    document.body.removeChild(ghostEl);
                    
                    if (touchDragState.lastHighlight) {
                        touchDragState.lastHighlight.classList.remove('highlight');
                    }
                    stumpedDropzone.classList.remove('highlight');
                    
                    if (droppedOnStumped) {
                        swapCountry(draggedEl);
                    } else if (dropZone && dropZone.tagName === 'path' && countrySvgIds.includes(dropZone.id) && !dropZone.classList.contains('correct')) {
                        if (draggedSvgId === dropZone.id) {
                            handleCorrectDrop(draggedSvgId, dropZone);
                        } else {
                            handleIncorrectDrop(draggedSvgId, dropZone);
                        }
                    } else {
                        handleIncorrectDrop(draggedSvgId, null);
                    }

                    touchDragState = { isDragging: false, draggedEl: null, ghostEl: null, draggedSvgId: null, lastHighlight: null };
                }
            }

            // --- Common Drag/Drop Logic ---
            function handleDragOver(e) { 
                e.preventDefault();
                handleAutoScroll(e.clientX, e.clientY);
            }

            function handleDragEnter(e) {
                const target = e.target;
                if (target.id === 'stumped-dropzone') {
                    target.classList.add('highlight');
                }
                else if (target.tagName === 'path' && countrySvgIds.includes(target.id) && !target.classList.contains('correct')) {
                    target.classList.add('highlight');
                }
            }

            function handleDragLeave(e) {
                const target = e.target;
                if (target.id === 'stumped-dropzone') {
                    target.classList.remove('highlight');
                }
                else if (target.tagName === 'path' && countrySvgIds.includes(target.id)) {
                    target.classList.remove('highlight');
                }
            }

            function handleDrop(e) {
                e.preventDefault();
                const draggedSvgId = e.dataTransfer.getData('text/plain');
                const dropZone = e.target;

                if (dropZone.id === 'stumped-dropzone') {
                    const draggedEl = document.querySelector(`[data-svg-id="${draggedSvgId}"]`);
                    if (draggedEl) swapCountry(draggedEl);
                    dropZone.classList.remove('highlight');
                    return;
                }

                if (dropZone.tagName !== 'path' || !countrySvgIds.includes(dropZone.id) || dropZone.classList.contains('correct')) {
                    handleIncorrectDrop(draggedSvgId);
                    return;
                }

                dropZone.classList.remove('highlight');

                if (draggedSvgId === dropZone.id) {
                    handleCorrectDrop(draggedSvgId, dropZone);
                } else {
                    handleIncorrectDrop(draggedSvgId, dropZone);
                }
            }
            
            function handleCorrectDrop(draggedSvgId, dropZonePath) {
                const draggedEl = document.querySelector(`[data-svg-id="${draggedSvgId}"]`);
                
                const neighbors = countryNeighbors[draggedSvgId] || [];
                const usedColors = new Set();
                const svgElement = mapContainer.querySelector('svg');
                const escapeCssSelector = (id) => id.replace(/([ \!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~])/g, '\\$1');
                neighbors.forEach(neighborId => {
                    const neighborPath = svgElement.querySelector(`#${escapeCssSelector(neighborId)}`);
                    if (neighborPath) {
                        for (const color of colors) {
                            if (neighborPath.classList.contains(color)) {
                                usedColors.add(color);
                                break;
                            }
                        }
                    }
                });
                const availableColors = colors.filter(c => !usedColors.has(c));
                const chosenColor = availableColors.length > 0 ? availableColors[Math.floor(Math.random() * availableColors.length)] : colors[Math.floor(Math.random() * colors.length)];
                dropZonePath.setAttribute('class', `correct ${chosenColor}`);
                
                updateScore(score + 1);

                const country = countries.find(c => c.svgId === draggedSvgId);
                if (country) {
                    const mapContent = document.getElementById('map-content');
                    const svg = mapContent.querySelector('svg');
                    const label = document.createElement('div');
                    label.className = 'country-label';
                    label.textContent = country.name;
                    
                    const mapContentRect = mapContent.getBoundingClientRect();
                    const mapContentStyle = window.getComputedStyle(mapContent);
                    const transform = new DOMMatrixReadOnly(mapContentStyle.transform);
                    const svgRect = svg.getBoundingClientRect();
                    const viewBox = svg.viewBox.baseVal;
                    const pathBBox = dropZonePath.getBBox();

                    const svgLeftOffset = svgRect.left - mapContentRect.left;
                    const svgTopOffset = svgRect.top - mapContentRect.top;

                    const effectiveSvgWidth = svgRect.width / transform.a;
                    const effectiveSvgHeight = svgRect.height / transform.d;

                    const scaleX = effectiveSvgWidth / viewBox.width;
                    const scaleY = effectiveSvgHeight / viewBox.height;
                    
                    let pathCenterXInUnits = pathBBox.x + pathBBox.width / 2;
                    let pathCenterYInUnits = pathBBox.y + pathBBox.height / 2;

                    const testPoint = svg.createSVGPoint();
                    testPoint.x = pathCenterXInUnits;
                    testPoint.y = pathCenterYInUnits;
                    if (!dropZonePath.isPointInFill(testPoint)) {
                        let found = false;
                        for (let i = 0.25; i <= 0.75 && !found; i += 0.25) {
                            for (let j = 0.25; j <= 0.75 && !found; j += 0.25) {
                                testPoint.x = pathBBox.x + pathBBox.width * i;
                                testPoint.y = pathBBox.y + pathBBox.height * j;
                                if (dropZonePath.isPointInFill(testPoint)) {
                                    pathCenterXInUnits = testPoint.x;
                                    pathCenterYInUnits = testPoint.y;
                                    found = true;
                                }
                            }
                        }
                    }

                    const labelX = ((pathCenterXInUnits - viewBox.x) * scaleX) + svgLeftOffset;
                    const labelY = ((pathCenterYInUnits - viewBox.y) * scaleY) + svgTopOffset;

                    label.style.left = `${labelX}px`;
                    label.style.top = `${labelY}px`;
                    
                    mapContent.appendChild(label);
                }

                if (isMobile) {
                    const parentSlot = draggedEl.parentElement;
                    parentSlot.innerHTML = '';
                    populateSingleTraySlot(parentSlot);
                } else {
                    draggedEl.style.display = 'none';
                }

                if (score === countries.length) {
                    endGame();
                }
            }

            function handleIncorrectDrop(draggedSvgId, dropZonePath) {
                if(dropZonePath && dropZonePath.tagName === 'path') {
                    dropZonePath.style.fill = 'rgba(220, 53, 69, 0.7)';
                    setTimeout(() => {
                        if (!dropZonePath.classList.contains('correct')) {
                           dropZonePath.style.fill = '';
                        }
                    }, 500);
                }
            }
            
            function endGame() {
                clearInterval(timerInterval);
                document.getElementById('final-time').textContent = `${timer}s`;
                document.getElementById('final-score').textContent = `${score} / ${countries.length}`;
                gameOverModal.style.display = 'flex';
            }
            
            function addDragListenersToElement(el) {
                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragend', handleDragEnd);
                el.addEventListener('touchstart', handleTouchStart, { passive: false });
            }

            function addDragListenersToAll() {
                const draggables = document.querySelectorAll('.country-name');
                draggables.forEach(addDragListenersToElement);
            }

            document.getElementById('restart-button').addEventListener('click', initGame);
            
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(initGame, 500);
            });
            
            // --- Global Touch Listeners ---
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);


            initGame();
        });
    </script>

</body>
</html>

