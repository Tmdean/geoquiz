<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Africa Map Quiz (Full Edition)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='16' fill='%234CAF50'/><path fill='%23FFF' d='M16 8c-3.5 0-7 2-9 5s-2 7-1 9 4 3 7 3 6-2 8-4 3-5 1-8-4-5-6-5z'/></svg>">
    <style>
        :root {
            --tray-height: 80px;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevents scrolling on all screen sizes */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
        }

        #game-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            gap: 20px;
            height: 100%;
            box-sizing: border-box;
        }

        #game-container {
            display: flex;
            gap: 30px;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        #map-container {
            width: 800px;
            flex-shrink: 0; /* Prevents map from shrinking in desktop flex layout */
            height: 100%;
            position: relative;
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #map-content {
            width: 100%;
            height: 100%;
            position: relative;
            transform-origin: center center;
            display: flex; 
            justify-content: center; 
            align-items: center;
        }

        #map-content svg {
            max-width: 100%;
            max-height: 100%;
            height: auto;
        }

        #map-container svg path {
            fill: #d4d4d4;
            stroke: #ffffff;
            stroke-width: 1px;
            transition: fill 0.2s ease-in-out;
        }
        
        #map-container svg path:hover {
            fill: #a3b4c1;
            cursor: crosshair;
        }

        #map-container svg path.highlight {
            fill: #f0ad4e;
        }
        
        #map-container svg path.correct {
            /* Marker class, colors handled by specific classes */
        }

        #map-container svg path.correct-color-1 { fill: #34d399; }
        #map-container svg path.correct-color-2 { fill: #fbbf24; }
        #map-container svg path.correct-color-3 { fill: #60a5fa; }
        #map-container svg path.correct-color-4 { fill: #f87171; }
        #map-container svg path.correct-color-5 { fill: #a855f7; }
        #map-container svg path.correct-color-6 { fill: #14b8a6; }

        #sidebar {
            width: 250px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: calc(100% - 40px); /* Adjust for body padding */
        }
        
        .country-label {
            position: absolute;
            transform: translate(-50%, -50%);
            color: black;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 0 3px white, 0 0 3px white, 0 0 3px white;
            pointer-events: none;
            user-select: none;
            text-align: center;
        }

        #info-panel {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
        }

        #info-panel h2 { margin-top: 0; }
        #timer, #score { font-size: 1.5em; font-weight: bold; color: #333; }

        #country-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .country-name {
            padding: 10px 12px;
            margin: 4px;
            font-size: 0.9em;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 5px;
            cursor: grab;
            text-align: center;
            user-select: none;
            transition: background-color 0.2s;
        }
        .country-name:hover { background-color: #dee2e6; }
        .country-name.dragging { opacity: 0.5; }

        #mobile-tray-container { display: none; } /* Hidden by default */
        
        #game-over-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        #game-over-content {
            background-color: white; padding: 40px; border-radius: 10px;
            text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #game-over-content h2 { margin-top: 0; color: #28a745; }
        #restart-button {
            padding: 10px 20px; font-size: 1em; cursor: pointer; border: none;
            border-radius: 5px; background-color: #007bff; color: white; margin-top: 20px;
        }
        #loading-indicator {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 1.2em; color: #555;
        }

        /* MOBILE LAYOUT */
        @media (max-width: 850px) {
            #game-wrapper {
                flex-direction: column;
                padding: 10px;
                gap: 10px;
            }
            #game-container {
                flex-direction: column;
                gap: 10px;
                flex-grow: 1; 
                min-height: 0; 
            }
            #sidebar { display: none; }

            #mobile-tray-container {
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            #mobile-info-panel {
                display: flex;
                justify-content: space-around;
                align-items: center;
                background-color: #fff;
                padding: 5px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                margin-bottom: 10px;
            }
            #mobile-info-panel div { font-size: 1em; }

            #mobile-country-tray {
                display: flex;
                justify-content: space-around;
                align-items: center;
                width: 100%;
                height: var(--tray-height);
            }
            .tray-slot {
                flex: 1;
                margin: 0 5px;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .tray-slot .country-name {
                width: 100%;
                padding: 8px 4px;
                font-size: 0.8em;
                box-sizing: border-box;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            #map-container {
                width: 100%;
                height: 100%; 
                box-sizing: border-box;
                overflow: scroll;
                -webkit-overflow-scrolling: touch; 
                display: block; /* Override desktop flex properties */
                text-align: left; /* MODIFIED: Ensure inline-block content aligns left */
            }
            
            #map-content {
                display: inline-block; /* Make wrapper shrink-to-fit its content */
                width: auto;
                height: auto;
                /* MODIFIED: Changed transition timing for smoother feel */
                transition: transform 0.2s ease-out;
                vertical-align: top; /* MODIFIED: Ensure content aligns to the top */
            }

            #map-container.zoomed #map-content {
                transform: scale(1.25);
            }

            #map-content svg {
                display: block;
                height: 120vh;
                width: auto;
                max-width: none;
                max-height: none;
                padding: 25%;
            }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <!-- Mobile-only tray -->
        <div id="mobile-tray-container">
             <div id="mobile-info-panel">
                <div>Score: <span id="mobile-score">0</span></div>
                <h2>Africa Quiz</h2>
                <div>Time: <span id="mobile-timer">0s</span></div>
            </div>
            <div id="mobile-country-tray"></div>
        </div>

        <div id="game-container">
            <div id="map-container">
                <div id="loading-indicator">Loading Map...</div>
            </div>

            <!-- Desktop-only sidebar -->
            <div id="sidebar">
                <div id="info-panel">
                    <h2>Africa Quiz</h2>
                    <div>Time: <span id="timer">0s</span></div>
                    <div>Score: <span id="score">0</span></div>
                </div>
                <ul id="country-list"></ul>
            </div>
        </div>
    </div>


    <div id="game-over-modal">
        <div id="game-over-content">
            <h2>Congratulations!</h2>
            <p>You've completed the map.</p>
            <p>Final Time: <span id="final-time"></span></p>
            <p>Final Score: <span id="final-score"></span></p>
            <button id="restart-button">Play Again</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const countries = [
                // North Africa
                { id: 'algeria', name: 'Algeria', svgId: 'Algerien' },
                { id: 'egypt', name: 'Egypt', svgId: 'Aegypten' },
                { id: 'libya', name: 'Libya', svgId: 'Libyen' },
                { id: 'morocco', name: 'Morocco', svgId: 'Marokko' },
                { id: 'sudan', name: 'Sudan', svgId: 'Sudan' },
                { id: 'tunisia', name: 'Tunisia', svgId: 'Tunesien' },
                { id: 'western-sahara', name: 'Western Sahara', svgId: 'Westsahara' },
                // West Africa
                { id: 'benin', name: 'Benin', svgId: 'Benin' },
                { id: 'burkina-faso', name: 'Burkina Faso', svgId: 'Burkina_Faso' },
                { id: 'ivory-coast', name: 'Côte d\'Ivoire', svgId: 'Elfenbeinkueste' },
                { id: 'gambia', name: 'Gambia', svgId: 'Gambia' },
                { id: 'ghana', name: 'Ghana', svgId: 'Ghana' },
                { id: 'guinea', name: 'Guinea', svgId: 'Guinea' },
                { id: 'guinea-bissau', name: 'Guinea-Bissau', svgId: 'Guinea-Bissau' },
                { id: 'liberia', name: 'Liberia', svgId: 'Liberia' },
                { id: 'mali', name: 'Mali', svgId: 'Mali' },
                { id: 'mauritania', name: 'Mauritania', svgId: 'Mauretanien' },
                { id: 'niger', name: 'Niger', svgId: 'Niger' },
                { id: 'nigeria', name: 'Nigeria', svgId: 'Nigeria' },
                { id: 'senegal', name: 'Senegal', svgId: 'Senegal' },
                { id: 'sierra-leone', name: 'Sierra Leone', svgId: 'Sierra_Leone' },
                { id: 'togo', name: 'Togo', svgId: 'Togo' },
                // Central Africa
                { id: 'angola', name: 'Angola', svgId: 'path73' },
                { id: 'cameroon', name: 'Cameroon', svgId: 'Kamerun' },
                { id: 'central-african-republic', name: 'Central African Republic', svgId: 'Zentralafrikanische_Republik' },
                { id: 'chad', name: 'Chad', svgId: 'Tschad' },
                { id: 'drc', name: 'DRC', svgId: 'Demokratische_Republik_Kongo' },
                { id: 'republic-of-the-congo', name: 'Congo', svgId: 'Republik_Kongo' },
                { id: 'equatorial-guinea', name: 'Equatorial Guinea', svgId: 'path64' },
                { id: 'gabon', name: 'Gabon', svgId: 'Gabun' },
                 // East Africa
                { id: 'burundi', name: 'Burundi', svgId: 'Burundi' },
                { id: 'djibouti', name: 'Djibouti', svgId: 'Dschibuti' },
                { id: 'eritrea', name: 'Eritrea', svgId: 'Eritrea' },
                { id: 'ethiopia', name: 'Ethiopia', svgId: 'Aethopien' },
                { id: 'kenya', name: 'Kenya', svgId: 'Kenia' },
                { id: 'madagascar', name: 'Madagascar', svgId: 'Madagaskar' },
                { id: 'malawi', name: 'Malawi', svgId: 'Malawi' },
                { id: 'mozambique', name: 'Mozambique', svgId: 'Mosambik' },
                { id: 'rwanda', name: 'Rwanda', svgId: 'Ruanda' },
                { id: 'somalia', name: 'Somalia', svgId: 'Somalia' },
                { id: 'south-sudan', name: 'South Sudan', svgId: 'path3246' },
                { id: 'tanzania', name: 'Tanzania', svgId: 'Tasania' },
                { id: 'uganda', name: 'Uganda', svgId: 'Uganda' },
                { id: 'zambia', name: 'Zambia', svgId: 'Sambia' },
                { id: 'zimbabwe', name: 'Zimbabwe', svgId: 'Simbabwe' },
                // Southern Africa
                { id: 'botswana', name: 'Botswana', svgId: 'Botsuana' },
                { id: 'eswatini', name: 'Eswatini', svgId: 'Swasiland' }, 
                { id: 'lesotho', name: 'Lesotho', svgId: 'Lesotho' },
                { id: 'namibia', name: 'Namibia', svgId: 'Namibia' },
                { id: 'south-africa', name: 'South Africa', svgId: 'Suedafrika' }
            ];
            const countryNeighbors = {
                'Algerien': ['Libyen', 'Marokko', 'Mauretanien', 'Mali', 'Niger', 'Tunesien', 'Westsahara'], 'Aegypten': ['Libyen', 'Sudan'], 'Libyen': ['Aegypten', 'Algerien', 'Tschad', 'Niger', 'Sudan', 'Tunesien'], 'Marokko': ['Algerien', 'Westsahara'], 'Sudan': ['Aegypten', 'Libyen', 'Tschad', 'Zentralafrikanische_Republik', 'Aethopien', 'Eritrea', 'path3246'], 'Tunesien': ['Algerien', 'Libyen'], 'Westsahara': ['Algerien', 'Marokko', 'Mauretanien'], 'Benin': ['Burkina_Faso', 'Niger', 'Nigeria', 'Togo'], 'Burkina_Faso': ['Benin', 'Elfenbeinkueste', 'Ghana', 'Mali', 'Niger', 'Togo'], 'Elfenbeinkueste': ['Burkina_Faso', 'Ghana', 'Guinea', 'Liberia', 'Mali'], 'Gambia': ['Senegal'], 'Ghana': ['Burkina_Faso', 'Elfenbeinkueste', 'Togo'], 'Guinea': ['Elfenbeinkueste', 'Guinea-Bissau', 'Liberia', 'Mali', 'Senegal', 'Sierra_Leone'], 'Guinea-Bissau': ['Guinea', 'Senegal'], 'Liberia': ['Elfenbeinkueste', 'Guinea', 'Sierra_Leone'], 'Mali': ['Algerien', 'Burkina_Faso', 'Elfenbeinkueste', 'Guinea', 'Mauretanien', 'Niger', 'Senegal'], 'Mauretanien': ['Algerien', 'Mali', 'Senegal', 'Westsahara'], 'Niger': ['Algerien', 'Benin', 'Burkina_Faso', 'Tschad', 'Libyen', 'Mali', 'Nigeria'], 'Nigeria': ['Benin', 'Kamerun', 'Tschad', 'Niger'], 'Senegal': ['Gambia', 'Guinea', 'Guinea-Bissau', 'Mali', 'Mauretanien'], 'Sierra_Leone': ['Guinea', 'Liberia'], 'Togo': ['Benin', 'Burkina_Faso', 'Ghana'], 'path73': ['Demokratische_Republik_Kongo', 'Republik_Kongo', 'Namibia', 'Sambia'], 'Kamerun': ['Zentralafrikanische_Republik', 'Tschad', 'Republik_Kongo', 'path64', 'Gabun', 'Nigeria'], 'Zentralafrikanische_Republik': ['Kamerun', 'Tschad', 'Demokratische_Republik_Kongo', 'Republik_Kongo', 'Sudan', 'path3246'], 'Tschad': ['Kamerun', 'Zentralafrikanische_Republik', 'Libyen', 'Niger', 'Nigeria', 'Sudan'], 'Demokratische_Republik_Kongo': ['path73', 'Zentralafrikanische_Republik', 'Republik_Kongo', 'path3246', 'Uganda', 'Ruanda', 'Burundi', 'Tasania', 'Sambia'], 'Republik_Kongo': ['path73', 'Kamerun', 'Zentralafrikanische_Republik', 'Demokratische_Republik_Kongo', 'Gabun'], 'path64': ['Kamerun', 'Gabun'], 'Gabun': ['Kamerun', 'Republik_Kongo', 'path64'], 'Burundi': ['Demokratische_Republik_Kongo', 'Ruanda', 'Tasania'], 'Dschibuti': ['Eritrea', 'Aethopien', 'Somalia'], 'Eritrea': ['Dschibuti', 'Aethopien', 'Sudan'], 'Aethopien': ['Dschibuti', 'Eritrea', 'Kenia', 'Somalia', 'path3246', 'Sudan'], 'Kenia': ['Aethopien', 'Somalia', 'path3246', 'Tasania', 'Uganda'], 'Madagaskar': [], 'Malawi': ['Mosambik', 'Tasania', 'Sambia'], 'Mosambik': ['Malawi', 'Suedafrika', 'Swasiland', 'Tasania', 'Sambia', 'Simbabwe'], 'Ruanda': ['Burundi', 'Demokratische_Republik_Kongo', 'Tasania', 'Uganda'], 'Somalia': ['Dschibuti', 'Aethopien', 'Kenia'], 'path3246': ['Zentralafrikanische_Republik', 'Demokratische_Republik_Kongo', 'Aethopien', 'Kenia', 'Sudan', 'Uganda'], 'Tasania': ['Burundi', 'Demokratische_Republik_Kongo', 'Kenia', 'Malawi', 'Mosambik', 'Ruanda', 'Uganda', 'Sambia'], 'Uganda': ['Demokratische_Republik_Kongo', 'Kenia', 'Ruanda', 'path3246', 'Tasania'], 'Sambia': ['path73', 'Botsuana', 'Demokratische_Republik_Kongo', 'Malawi', 'Mosambik', 'Namibia', 'Tasania', 'Simbabwe'], 'Simbabwe': ['Botsuana', 'Mosambik', 'Suedafrika', 'Sambia'], 'Botsuana': ['Namibia', 'Suedafrika', 'Sambia', 'Simbabwe'], 'Swasiland': ['Mosambik', 'Suedafrika'], 'Lesotho': ['Suedafrika'], 'Namibia': ['path73', 'Botsuana', 'Suedafrika', 'Sambia'], 'Suedafrika': ['Botsuana', 'Lesotho', 'Mosambik', 'Namibia', 'Swasiland', 'Simbabwe']
            };
            const colors = ['correct-color-1', 'correct-color-2', 'correct-color-3', 'correct-color-4', 'correct-color-5', 'correct-color-6'];
            const countrySvgIds = countries.map(c => c.svgId);
            
            // --- UI Elements ---
            const mapContainer = document.getElementById('map-container');
            const gameOverModal = document.getElementById('game-over-modal');
            // Desktop
            const countryList = document.getElementById('country-list');
            const scoreEl = document.getElementById('score');
            const timerEl = document.getElementById('timer');
            // Mobile
            const mobileTray = document.getElementById('mobile-country-tray');
            const mobileScoreEl = document.getElementById('mobile-score');
            const mobileTimerEl = document.getElementById('mobile-timer');

            // --- Game State ---
            let score = 0;
            let timer = 0;
            let timerInterval;
            let unplacedCountries = [];
            let misplaceCounters = {};
            const TRAY_SIZE = 4;
            const MISPLACE_THRESHOLD = 1; // Updated from 3 to 1
            // Global state for touch drag
            let touchDragState = {
                isDragging: false,
                draggedEl: null,
                ghostEl: null,
                draggedSvgId: null,
                lastHighlight: null,
            };

            async function initGame() {
                score = 0;
                timer = 0;
                if (timerInterval) clearInterval(timerInterval);
                updateScore(0);
                updateTimer(0);
                
                gameOverModal.style.display = 'none';
                if(document.getElementById('map-content')) {
                     document.querySelectorAll('.country-label').forEach(label => label.remove());
                }

                unplacedCountries = [...countries];
                misplaceCounters = {};

                const isMobile = window.innerWidth <= 850;
                
                if (isMobile) {
                    setupMobileTray();
                } else {
                    setupDesktopSidebar();
                }
                
                await loadMap();
                startTimer();
            }

            function setupDesktopSidebar() {
                countryList.innerHTML = '';
                const shuffled = [...countries].sort(() => Math.random() - 0.5);
                shuffled.forEach(country => {
                    countryList.appendChild(createDraggableElement(country));
                });
                addDragListenersToAll();
            }

            function setupMobileTray() {
                mobileTray.innerHTML = '';
                for (let i = 0; i < TRAY_SIZE; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'tray-slot';
                    mobileTray.appendChild(slot);
                }
                populateMobileTray();
            }

            function populateMobileTray() {
                const traySlots = document.querySelectorAll('.tray-slot');
                traySlots.forEach(slot => {
                    if (slot.childElementCount === 0 && unplacedCountries.length > 0) {
                        const randomIndex = Math.floor(Math.random() * unplacedCountries.length);
                        const country = unplacedCountries.splice(randomIndex, 1)[0];
                        
                        const draggableEl = createDraggableElement(country);
                        slot.appendChild(draggableEl);
                        addDragListenersToElement(draggableEl);
                    }
                });
            }

            function createDraggableElement(country) {
                const li = document.createElement('div');
                li.className = 'country-name';
                li.draggable = true;
                li.id = `name-${country.id}`;
                li.dataset.svgId = country.svgId;
                li.textContent = country.name;
                return li;
            }
            
            async function loadMap() {
                const isMobile = window.innerWidth <= 850;

                mapContainer.innerHTML = '<div id="loading-indicator">Loading Map...</div>';
                try {
                    const response = await fetch('https://upload.wikimedia.org/wikipedia/commons/6/66/Blank_Map-Africa.svg');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const svgText = await response.text();
                    
                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(svgText, "image/svg+xml");
                    const svgElement = svgDoc.documentElement;
                    
                    svgElement.removeAttribute('width');
                    svgElement.removeAttribute('height');
                    
                    mapContainer.innerHTML = ''; 
                    const mapContent = document.createElement('div');
                    mapContent.id = 'map-content';
                    mapContent.appendChild(svgElement);
                    
                    mapContainer.appendChild(mapContent);

                    if (isMobile) {
                        mapContainer.style.padding = "12.5%";
                        mapContainer.scroll({
                            left: (mapContainer.scrollWidth - mapContainer.offsetWidth) / 2,
                            top: (mapContainer.scrollHeight - mapContainer.offsetHeight) / 2
                        });
                    }
                    
                    const escapeCssSelector = (id) => id.replace(/([ \!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~])/g, '\\$1');

                    countrySvgIds.forEach(id => {
                        const path = svgElement.querySelector(`#${escapeCssSelector(id)}`);
                        if (path) path.removeAttribute('style');
                    });

                    svgElement.addEventListener('dragover', handleDragOver);
                    svgElement.addEventListener('drop', handleDrop);
                    svgElement.addEventListener('dragenter', handleDragEnter);
                    svgElement.addEventListener('dragleave', handleDragLeave);

                } catch (error) {
                    mapContainer.innerHTML = `<p style="color: red;">Failed to load map: ${error.message}</p>`;
                }
            }

            function updateScore(newScore) {
                score = newScore;
                scoreEl.textContent = score;
                mobileScoreEl.textContent = score;
            }

            function updateTimer(newTime) {
                timer = newTime;
                timerEl.textContent = `${timer}s`;
                mobileTimerEl.textContent = `${timer}s`;
            }

            function startTimer() {
                const startTime = Date.now();
                timerInterval = setInterval(() => {
                    updateTimer(Math.floor((Date.now() - startTime) / 1000));
                }, 1000);
            }
            
            function setZoom(zoomed) {
                 const isMobile = window.innerWidth <= 850;
                 if (isMobile) {
                    mapContainer.classList.toggle('zoomed', zoomed);
                 }
            }

            function handleAutoScroll(clientX, clientY, behavior) {
                const isMobile = window.innerWidth <= 850;
                if (!isMobile || !mapContainer) return;

                const mapRect = mapContainer.getBoundingClientRect();
                const activeMargin = 40;

                const mapContent = document.getElementById('map-content');
                if (!mapContent) return;

                // --- Robust Max Scroll Calculation ---
                const svg = mapContent.querySelector('svg');
                if (!svg) return;

                const svgRect = svg.getBoundingClientRect();
                const isZoomed = mapContainer.classList.contains('zoomed');
                const scale = isZoomed ? 1 : 1.25;

                const scaledWidth = svgRect.width * scale;
                const scaledHeight = svgRect.height * scale;

                const maxScrollLeft = Math.max(0, scaledWidth - mapContainer.clientWidth);
                const maxScrollTop = Math.max(0, scaledHeight - mapContainer.clientHeight);

                var newScroll = { left: mapContainer.scrollLeft, top: mapContainer.scrollTop, behavior };
                // --- Horizontal Scrolling ---
                if (maxScrollLeft > 0) {
                    const activeWidth = mapRect.width - (2 * activeMargin);
                    if (activeWidth > 0) {
                        const posInContainer = clientX - mapRect.left;
                        const posInActive = Math.max(0, Math.min(activeWidth, posInContainer - activeMargin));
                        const fraction = posInActive / activeWidth;
                        newScroll.left = fraction * maxScrollLeft;
                    }
                }

                // --- Vertical Scrolling ---
                if (maxScrollTop > 0) {
                    const activeHeight = mapRect.height - (2 * activeMargin);
                    if (activeHeight > 0) {
                        const posYInContainer = clientY - mapRect.top;
                        const posYInActive = Math.max(0, Math.min(activeHeight, posYInContainer - activeMargin));
                        const fractionY = posYInActive / activeHeight;
                        newScroll.top = fractionY * maxScrollTop;
                    }
                }

                mapContainer.scroll(newScroll);
            }

            // --- Mouse Drag Events ---
            function handleDragStart(e) {
                setZoom(true);
                e.dataTransfer.setData('text/plain', e.target.dataset.svgId);
                setTimeout(() => e.target.classList.add('dragging'), 0);
            }

            function handleDragEnd(e) {
                setZoom(false);
                const highlighted = document.querySelector('.highlight');
                if (highlighted) highlighted.classList.remove('highlight');
                e.target.classList.remove('dragging');
            }

            // --- Touch Drag Events ---
            function handleTouchStart(e) {
                if (e.target.classList.contains('country-name')) {
                    e.preventDefault();
                    const touch = e.touches[0];

                    handleAutoScroll(touch.clientX, touch.clientY, 'smooth');
                    setZoom(true);
                    
                    const draggedEl = e.target;
                    const draggedSvgId = draggedEl.dataset.svgId;
                    const ghostEl = draggedEl.cloneNode(true);
                    
                    ghostEl.style.position = 'absolute';
                    ghostEl.style.zIndex = '1001';
                    ghostEl.style.opacity = '0.7';
                    ghostEl.style.pointerEvents = 'none';
                    document.body.appendChild(ghostEl);

                    ghostEl.style.left = `${touch.pageX - ghostEl.offsetWidth / 2}px`;
                    ghostEl.style.top = `${touch.pageY - ghostEl.offsetHeight / 2}px`;

                    touchDragState = { isDragging: true, draggedEl, ghostEl, draggedSvgId, lastHighlight: null };
                }
            }
            
            function handleTouchMove(e) {
                if (touchDragState.isDragging) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const { ghostEl } = touchDragState;
                    
                    handleAutoScroll(touch.clientX, touch.clientY, 'instant');

                    if(ghostEl) {
                        ghostEl.style.left = `${touch.pageX - ghostEl.offsetWidth / 2}px`;
                        ghostEl.style.top = `${touch.pageY - ghostEl.offsetHeight / 2}px`;
                    }
                    
                    if(touchDragState.draggedEl) touchDragState.draggedEl.style.visibility = 'hidden';

                    const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);

                    if (touchDragState.lastHighlight && touchDragState.lastHighlight !== elementUnderTouch) {
                        touchDragState.lastHighlight.classList.remove('highlight');
                        touchDragState.lastHighlight = null;
                    }

                    if (elementUnderTouch && elementUnderTouch.tagName === 'path' && countrySvgIds.includes(elementUnderTouch.id) && !elementUnderTouch.classList.contains('correct')) {
                        elementUnderTouch.classList.add('highlight');
                        touchDragState.lastHighlight = elementUnderTouch;
                    }
                }
            }

            function handleTouchEnd(e) {
                if (touchDragState.isDragging) {
                    const { ghostEl, draggedSvgId, draggedEl } = touchDragState;
                    
                    if(ghostEl) ghostEl.style.display = 'none';

                    const mapContent = document.getElementById('map-content');
                    if (mapContent) {
                        mapContent.style.transition = 'none';
                    }

                    setTimeout(() => setZoom(false));

                    const touch = e.changedTouches[0];
                    const dropZonePath = document.elementFromPoint(touch.clientX, touch.clientY);
                    
                    if (ghostEl && document.body.contains(ghostEl)) {
                        document.body.removeChild(ghostEl);
                    }
                    if (draggedEl) draggedEl.style.visibility = 'visible';

                    if (mapContent) {
                        mapContent.style.transition = '';
                    }

                    if (touchDragState.lastHighlight) {
                        touchDragState.lastHighlight.classList.remove('highlight');
                    }

                    if (dropZonePath && dropZonePath.tagName === 'path' && countrySvgIds.includes(dropZonePath.id) && !dropZonePath.classList.contains('correct')) {
                        if (draggedSvgId === dropZonePath.id) {
                            handleCorrectDrop(draggedSvgId, dropZonePath);
                        } else {
                            handleIncorrectDrop(draggedSvgId, dropZonePath);
                        }
                    } else {
                        handleIncorrectDrop(draggedSvgId, null);
                    }

                    touchDragState = { isDragging: false, draggedEl: null, ghostEl: null, draggedSvgId: null, lastHighlight: null };
                }
            }


            // --- Common Drag/Drop Logic ---
            function handleDragOver(e) { 
                e.preventDefault();
                handleAutoScroll(e.clientX, e.clientY, 'instant');
            }

            function handleDragEnter(e) {
                const path = e.target;
                if (path.tagName === 'path' && countrySvgIds.includes(path.id) && !path.classList.contains('correct')) {
                    path.classList.add('highlight');
                }
            }

            function handleDragLeave(e) {
                const path = e.target;
                if (path.tagName === 'path' && countrySvgIds.includes(path.id)) {
                    path.classList.remove('highlight');
                }
            }

            function handleDrop(e) {
                e.preventDefault();
                setZoom(false);
                const draggedSvgId = e.dataTransfer.getData('text/plain');
                const dropZonePath = e.target;

                if (dropZonePath.tagName !== 'path' || !countrySvgIds.includes(dropZonePath.id) || dropZonePath.classList.contains('correct')) {
                    const highlighted = document.querySelector('.highlight');
                    if (highlighted) highlighted.classList.remove('highlight');
                    handleIncorrectDrop(draggedSvgId);
                    return;
                }

                dropZonePath.classList.remove('highlight');

                if (draggedSvgId === dropZonePath.id) {
                    handleCorrectDrop(draggedSvgId, dropZonePath);
                } else {
                    handleIncorrectDrop(draggedSvgId, dropZonePath);
                }
            }
            
            function handleCorrectDrop(draggedSvgId, dropZonePath) {
                const draggedEl = document.querySelector(`[data-svg-id="${draggedSvgId}"]`);
                
                const neighbors = countryNeighbors[draggedSvgId] || [];
                const usedColors = new Set();
                const svgElement = mapContainer.querySelector('svg');
                const escapeCssSelector = (id) => id.replace(/([ \!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~])/g, '\\$1');
                neighbors.forEach(neighborId => {
                    const neighborPath = svgElement.querySelector(`#${escapeCssSelector(neighborId)}`);
                    if (neighborPath) {
                        for (const color of colors) {
                            if (neighborPath.classList.contains(color)) {
                                usedColors.add(color);
                                break;
                            }
                        }
                    }
                });
                const availableColors = colors.filter(c => !usedColors.has(c));
                const chosenColor = availableColors.length > 0 ? availableColors[Math.floor(Math.random() * availableColors.length)] : colors[Math.floor(Math.random() * colors.length)];
                dropZonePath.setAttribute('class', `correct ${chosenColor}`);
                
                updateScore(score + 1);

                const country = countries.find(c => c.svgId === draggedSvgId);
                if (country) {
                    const mapContent = document.getElementById('map-content');
                    const svg = mapContent.querySelector('svg');
                    const label = document.createElement('div');
                    label.className = 'country-label';
                    label.textContent = country.name;
                    
                    const mapContentRect = mapContent.getBoundingClientRect();
                    const mapContentStyle = window.getComputedStyle(mapContent);
                    const transformStr = mapContentStyle.transform;
                    const transform = transformStr === 'none' ? new DOMMatrixReadOnly() : new DOMMatrixReadOnly(transformStr);
                    const svgRect = svg.getBoundingClientRect();
                    const viewBox = svg.viewBox.baseVal;
                    const pathBBox = dropZonePath.getBBox();

                    const svgLeftOffset = svgRect.left - mapContentRect.left;
                    const svgTopOffset = svgRect.top - mapContentRect.top;

                    const effectiveSvgWidth = svgRect.width / transform.a;
                    const effectiveSvgHeight = svgRect.height / transform.d;

                    const scaleX = effectiveSvgWidth / viewBox.width;
                    const scaleY = effectiveSvgHeight / viewBox.height;
                    
                    let pathCenterXInUnits = pathBBox.x + pathBBox.width / 2;
                    let pathCenterYInUnits = pathBBox.y + pathBBox.height / 2;

                    const testPoint = svg.createSVGPoint();
                    testPoint.x = pathCenterXInUnits;
                    testPoint.y = pathCenterYInUnits;
                    if (!dropZonePath.isPointInFill(testPoint)) {
                        let found = false;
                        for (let i = 0.1; i <= 0.9 && !found; i += 0.1) {
                            for (let j = 0.1; j <= 0.9 && !found; j += 0.1) {
                                testPoint.x = pathBBox.x + pathBBox.width * i;
                                testPoint.y = pathBBox.y + pathBBox.height * j;
                                if (dropZonePath.isPointInFill(testPoint)) {
                                    pathCenterXInUnits = testPoint.x;
                                    pathCenterYInUnits = testPoint.y;
                                    found = true;
                                }
                            }
                        }
                    }

                    const labelX = ((pathCenterXInUnits - viewBox.x) * scaleX) + svgLeftOffset;
                    const labelY = ((pathCenterYInUnits - viewBox.y) * scaleY) + svgTopOffset;

                    label.style.left = `${labelX}px`;
                    label.style.top = `${labelY}px`;
                    
                    mapContent.appendChild(label);
                }

                const isMobile = window.innerWidth <= 850;
                if (isMobile) {
                    const parentSlot = draggedEl.parentElement;
                    parentSlot.innerHTML = '';
                    populateMobileTray();
                } else {
                    draggedEl.style.display = 'none';
                }

                if (score === countries.length) {
                    endGame();
                }
            }


            function handleIncorrectDrop(draggedSvgId, dropZonePath) {
                if(dropZonePath && dropZonePath.tagName === 'path') {
                    dropZonePath.style.fill = 'rgba(220, 53, 69, 0.7)';
                    setTimeout(() => {
                        if (!dropZonePath.classList.contains('correct')) {
                           dropZonePath.style.fill = '';
                        }
                    }, 500);
                }
                
                const isMobile = window.innerWidth <= 850;
                if (isMobile) {
                    misplaceCounters[draggedSvgId] = (misplaceCounters[draggedSvgId] || 0) + 1;
                    if (misplaceCounters[draggedSvgId] >= MISPLACE_THRESHOLD) {
                        const elToReplace = document.querySelector(`[data-svg-id="${draggedSvgId}"]`);
                        if(elToReplace) {
                            const parentSlot = elToReplace.parentElement;
                            const countryData = countries.find(c => c.svgId === draggedSvgId);
                            if(countryData) unplacedCountries.push(countryData);
                            
                            misplaceCounters[draggedSvgId] = 0;
                            parentSlot.innerHTML = '';
                            populateMobileTray();
                        }
                    }
                }
            }
            
            function endGame() {
                clearInterval(timerInterval);
                document.getElementById('final-time').textContent = `${timer}s`;
                document.getElementById('final-score').textContent = `${score} / ${countries.length}`;
                gameOverModal.style.display = 'flex';
            }
            
            function addDragListenersToElement(el) {
                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragend', handleDragEnd);
                el.addEventListener('touchstart', handleTouchStart, { passive: false });
            }

            function addDragListenersToAll() {
                const draggables = document.querySelectorAll('.country-name');
                draggables.forEach(addDragListenersToElement);
            }

            document.getElementById('restart-button').addEventListener('click', initGame);
            
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(initGame, 500);
            });
            
            // --- Global Touch Listeners ---
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);


            initGame();
        });
    </script>

</body>
</html>

